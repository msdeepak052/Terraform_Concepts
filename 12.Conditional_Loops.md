# **1️⃣ Conditionals in Terraform**

Terraform supports **ternary-style conditionals** and `if expressions` to make decisions dynamically.

### **Syntax (Ternary style)**

```hcl
condition ? true_value : false_value
```

### **Example 1: Basic conditional**

```hcl
variable "env" {
  default = "dev"
}

output "instance_type" {
  value = var.env == "prod" ? "t3.large" : "t2.micro"
}
```

* `env=dev` → `t2.micro`
* `env=prod` → `t3.large`

### **Example 2: Conditional with lists**

```hcl
variable "env" {
  default = "dev"
}

variable "azs" {
  default = ["ap-south-1a", "ap-south-1b"]
}

output "selected_azs" {
  value = var.env == "prod" ? var.azs : [var.azs[0]]
}
```

* For `prod` → all AZs
* For `dev` → only the first AZ

### **Example 3: Conditional with maps**

```hcl
variable "env" {
  default = "qa"
}

output "tags" {
  value = var.env == "prod" ? {Environment="prod", Owner="Ops"} : {Environment=var.env, Owner="Dev"}
}
```

✅ Conditionals allow **dynamic resource configuration** based on environment, region, or any variable.

---

# **2️⃣ Loops in Terraform**

Terraform has multiple ways to loop: `count`, `for_each`, and `for expressions`. Each has **different use-cases**.

---

## **2a. count**

* `count` lets you create **multiple instances of a resource**.
* Works with **number type**.

### **Example 1: Create multiple EC2 instances**

```hcl
variable "instance_count" {
  default = 3
}

resource "aws_instance" "web" {
  count         = var.instance_count
  ami           = "ami-0c55b159cbfafe1f0"
  instance_type = "t2.micro"
  tags = {
    Name = "web-${count.index}"
  }
}
```

* Creates 3 EC2 instances: `web-0`, `web-1`, `web-2`.

### **Example 2: Conditional count**

```hcl
variable "create_instance" {
  default = true
}

resource "aws_instance" "conditional" {
  count = var.create_instance ? 1 : 0
  ami   = "ami-0c55b159cbfafe1f0"
  instance_type = "t2.micro"
}
```

* Creates the instance **only if `create_instance=true`**.

---

## **2b. for_each**

* `for_each` works with **maps or sets**.
* Each element becomes a separate resource with a **unique key**.

### **Example 1: Multiple EC2 instances with map**

```hcl
variable "servers" {
  default = {
    "web" = "t2.micro"
    "app" = "t2.small"
  }
}

resource "aws_instance" "multi" {
  for_each      = var.servers
  ami           = "ami-0c55b159cbfafe1f0"
  instance_type = each.value
  tags = {
    Name = each.key
  }
}
```

* Creates two instances:

  * `web` → `t2.micro`
  * `app` → `t2.small`

### **Example 2: for_each with set**

```hcl
variable "envs" {
  default = ["dev","qa","prod"]
}

resource "aws_s3_bucket" "buckets" {
  for_each = toset(var.envs)
  bucket   = "mybucket-${each.key}"
  acl      = "private"
}
```

* Creates 3 S3 buckets: `mybucket-dev`, `mybucket-qa`, `mybucket-prod`.

---

## **2c. for expressions**

* `for expressions` let you **transform lists or maps** into another list or map.
* Useful to **compute dynamic values**.

### **Example 1: Transform list**

```hcl
variable "azs" {
  default = ["ap-south-1a", "ap-south-1b"]
}

output "upper_azs" {
  value = [for az in var.azs : upper(az)]
}
```

**Output:** `["AP-SOUTH-1A","AP-SOUTH-1B"]`

### **Example 2: Map from list**

```hcl
variable "servers" {
  default = ["web","app"]
}

output "server_map" {
  value = {for s in var.servers : s => "${s}-instance"}
}
```

**Output:** `{"web"="web-instance", "app"="app-instance"}`

### **Example 3: Conditional in for expression**

```hcl
variable "envs" {
  default = ["dev","qa","prod"]
}

output "prod_only" {
  value = [for e in var.envs : e if e == "prod"]
}
```

**Output:** `["prod"]`

---

# **2d. if expressions inside for expressions**

* You can **filter or compute values conditionally**.

### **Example 1: Conditional tags**

```hcl
variable "servers" {
  default = ["web","app","db"]
}

output "tags" {
  value = {for s in var.servers : s => (s=="db" ? "database" : "application")}
}
```

**Output:** `{"web"="application","app"="application","db"="database"}`

### **Example 2: Filter list**

```hcl
variable "envs" {
  default = ["dev","qa","prod"]
}

output "non_prod" {
  value = [for e in var.envs : e if e != "prod"]
}
```

**Output:** `["dev","qa"]`

---

# **3️⃣ Real-Life Example Combining Everything**

Suppose we want to create **multiple EC2 instances** with **different types based on environment**, and **output their names and IDs dynamically**:

```hcl
variable "envs" {
  default = ["dev","qa","prod"]
}

variable "instance_type_map" {
  default = {
    dev  = "t2.micro"
    qa   = "t2.small"
    prod = "t3.large"
  }
}

resource "aws_instance" "web" {
  for_each = toset(var.envs)
  ami           = "ami-0c55b159cbfafe1f0"
  instance_type = var.instance_type_map[each.key]
  tags = {
    Name = "${each.key}-web"
    Env  = each.key
  }
}

output "instance_info" {
  value = {for k, v in aws_instance.web : k => v.id}
}
```

✅ This dynamically:

* Creates instances per environment
* Picks instance type using a map (conditional logic)
* Uses `for_each` and `for expression` to output a map of instance IDs

---

# **Summary Table**

| Feature             | Purpose                   | Data Types                | Example                                 |
| ------------------- | ------------------------- | ------------------------- | --------------------------------------- |
| Conditional (`? :`) | Choose values dynamically | string, number, list, map | `var.env=="prod"?"t3.large":"t2.micro"` |
| `count`             | Repeat resource N times   | number                    | `count=3`                               |
| `for_each`          | Loop over map or set      | map, set                  | `for_each=var.servers`                  |
| `for expression`    | Transform list/map        | list, map                 | `[for az in var.azs: upper(az)]`        |
| `if expression`     | Conditional inside for    | list, map                 | `[for e in var.envs: e if e!="prod"]`   |

---
